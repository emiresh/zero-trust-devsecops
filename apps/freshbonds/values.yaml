app:
  name: freshbonds

namespace: dev

# Default values for all deployments (can be overridden per deployment)
# Based on actual usage analysis: CPU 1m, Memory 2-38Mi
# Requests set with 10x safety margin, Limits allow 10x burst
defaults:
  resources:
    limits:
      cpu: "100m"
      memory: "128Mi"
    requests:
      cpu: "10m"
      memory: "32Mi"
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    privileged: false
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

# Secrets are now managed via Sealed Secrets
# See templates/sealed-secret.yaml
# To update secrets:
# 1. Create a plain secret file (don't commit!)
# 2. Seal it: kubeseal --controller-namespace sealed-secrets --format yaml < plain-secret.yaml > templates/sealed-secret.yaml
# 3. Commit the sealed-secret.yaml file

deployments:
  - name: apigateway
    replicaCount: 2
    image:
      repository: docker.io/emiresh/freshbonds-api-gateway
      tag: v1.0.59
      pullPolicy: IfNotPresent
    service:
      name: apigateway-service
      port: 8080
      targetPort: 8080
    ingress:
      enabled: false
    healthCheck:
      liveness:
        path: /health/live
        initialDelaySeconds: 10
        periodSeconds: 30
        timeoutSeconds: 3
        failureThreshold: 3
      readiness:
        path: /health/ready
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 3
        failureThreshold: 3
    envFrom:
      - secretRef:
          name: freshbonds-secrets
    env:
      - name: USER_SERVICE_URL
        value: "http://user-service:8082"
      - name: PRODUCT_SERVICE_URL
        value: "http://product-service:8081"
      - name: PORT
        value: "8080"

  - name: frontend
    replicaCount: 2
    image:
      repository: docker.io/emiresh/freshbonds-frontend
      tag: v1.0.59
      pullPolicy: IfNotPresent
    resources:
      limits:
        cpu: "50m"
        memory: "64Mi"
      requests:
        cpu: "5m"
        memory: "16Mi"
    service:
      name: frontend-service
      port: 80
      targetPort: 3000
    ingress:
      enabled: true
      path: /
      pathType: Prefix
    env:
      - name: API_GATEWAY_HOST
        value: "apigateway-service"
      - name: API_GATEWAY_PORT
        value: "8080"
      - name: REACT_APP_API_URL
        value: "http://apigateway-service:8080"
      - name: NODE_ENV
        value: "production"
    volumes:
      - name: nginx-cache
      - name: nginx-run
    volumeMounts:
      - name: nginx-cache
        mountPath: /var/cache/nginx
      - name: nginx-run
        mountPath: /var/run

  - name: product-service
    replicaCount: 2
    image:
      repository: docker.io/emiresh/freshbonds-product-service
      tag: v1.0.59
      pullPolicy: IfNotPresent
    resources:
      limits:
        cpu: "100m"
        memory: "128Mi"
      requests:
        cpu: "10m"
        memory: "64Mi"
    service:
      name: product-service
      port: 8081
      targetPort: 3002
    ingress:
      enabled: false
    healthCheck:
      liveness:
        path: /health/live
        initialDelaySeconds: 10
        periodSeconds: 30
        timeoutSeconds: 3
        failureThreshold: 3
      readiness:
        path: /health/ready
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 3
        failureThreshold: 3
    envFrom:
      - secretRef:
          name: freshbonds-secrets
    env:
      - name: SERVICE_PORT
        value: "3002"

  - name: user-service
    replicaCount: 2
    image:
      repository: docker.io/emiresh/freshbonds-user-service
      tag: v1.0.59
      pullPolicy: IfNotPresent
    resources:
      limits:
        cpu: "100m"
        memory: "128Mi"
      requests:
        cpu: "10m"
        memory: "64Mi"
    service:
      name: user-service
      port: 8082
      targetPort: 3001
    ingress:
      enabled: false
    healthCheck:
      liveness:
        path: /health/live
        initialDelaySeconds: 10
        periodSeconds: 30
        timeoutSeconds: 3
        failureThreshold: 3
      readiness:
        path: /health/ready
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 3
        failureThreshold: 3
    envFrom:
      - secretRef:
          name: freshbonds-secrets
    env:
      - name: SERVICE_PORT
        value: "3001"

ingress:
  className: nginx
  host: freshbonds.com
  sslRedirect: false
  forceSslRedirect: true
  rewriteTarget: /
  tls:
    enabled: true
    clusterIssuer: letsencrypt
    secretName: freshbonds-tls
