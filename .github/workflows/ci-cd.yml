name: CI/CD Pipeline - FreshBonds

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'apps/*/templates/**'
      - 'Dockerfile'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'apps/*/templates/**'
      - 'Dockerfile'

permissions:
  contents: write          # Required for pushing manifest updates
  security-events: write   # Required for SARIF uploads
  packages: read
  pull-requests: write     # For PR comments

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_PREFIX: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # ==========================================
  # STAGE 1: Detect Changes
  # ==========================================
  detect-changes:
    name: üîç Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Services
        id: detect
        run: |
          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "üìù Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Initialize services array
          SERVICES=()
          
          # Check each service directory
          if echo "$CHANGED_FILES" | grep -q "^src/frontend/"; then
            SERVICES+=("frontend")
            echo "‚úÖ Detected: frontend"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/api-gateway/"; then
            SERVICES+=("api-gateway")
            echo "‚úÖ Detected: api-gateway"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/user-service/"; then
            SERVICES+=("user-service")
            echo "‚úÖ Detected: user-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/product-service/"; then
            SERVICES+=("product-service")
            echo "‚úÖ Detected: product-service"
          fi
          
          # If workflow or Dockerfile changed, rebuild all
          if echo "$CHANGED_FILES" | grep -qE "^(\.github/workflows/|Dockerfile)"; then
            echo "‚ö†Ô∏è Workflow or Dockerfile changed - rebuilding all services"
            SERVICES=("frontend" "api-gateway" "user-service" "product-service")
          fi
          
          # Create JSON array
          if [[ ${#SERVICES[@]} -eq 0 ]]; then
            echo "‚ÑπÔ∏è No services to build"
            SERVICES_JSON="[]"
            HAS_CHANGES="false"
          else
            SERVICES_JSON="["
            for i in "${!SERVICES[@]}"; do
              if [[ $i -gt 0 ]]; then
                SERVICES_JSON+=","
              fi
              SERVICES_JSON+="\"${SERVICES[$i]}\""
            done
            SERVICES_JSON+="]"
            HAS_CHANGES="true"
          fi
          
          echo ""
          echo "üéØ Services to build: ${SERVICES[*]}"
          echo "üìä JSON matrix: $SERVICES_JSON"
          
          # Validate JSON
          if ! echo "$SERVICES_JSON" | jq empty >/dev/null 2>&1; then
            echo "‚ùå Invalid JSON, using fallback"
            SERVICES_JSON='[]'
            HAS_CHANGES="false"
          fi
          
          echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ==========================================
  # STAGE 2: Infrastructure Security & Compliance Validation
  # ==========================================
  policy-checks:
    name: üîê Validate Infrastructure & Security Policies
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    
    permissions:
      contents: read
      security-events: write  # Required for uploading SARIF files
      actions: read           # Required for workflow run API access
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Kubernetes Manifests with OPA (Policy-as-Code)
        if: hashFiles('policies/opa/**') != ''
        run: |
          echo "üîç Validating Kubernetes manifests with OPA policies..."
          echo ""
          
          # Install Conftest
          CONFTEST_VERSION=0.63.0
          curl -sL https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz | tar xz
          sudo mv conftest /usr/local/bin/
          
          # Install Helm
          curl -s https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash > /dev/null 2>&1
          
          # Render and test Helm charts
          for chart in apps/*/; do
            if [[ -f "$chart/Chart.yaml" ]]; then
              chart_name=$(basename "$chart")
              echo "üì¶ Testing: $chart_name"
              
              # Render Helm template
              helm template "$chart_name" "$chart" > "/tmp/${chart_name}.yaml" 2>/dev/null || continue
              
              # Run OPA validation
              conftest test --policy ./policies/opa "/tmp/${chart_name}.yaml" > /tmp/results.txt 2>&1 || true
              
              # Show results
              cat /tmp/results.txt
              
              # Parse summary
              SUMMARY=$(tail -1 /tmp/results.txt)
              PASSED=$(echo "$SUMMARY" | grep -oP '\d+(?= passed)' || echo "0")
              WARNINGS=$(echo "$SUMMARY" | grep -oP '\d+(?= warnings)' || echo "0")
              FAILURES=$(echo "$SUMMARY" | grep -oP '\d+(?= failures)' || echo "0")
              
              # GitHub Summary
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üîê OPA Validation: $chart_name
          **Policy-as-Code:** Custom security rules and business logic validation
          
          | ‚úÖ Passed | ‚ö†Ô∏è Warnings | ‚ùå Failures |
          |-----------|-------------|-------------|
          | $PASSED | $WARNINGS | $FAILURES |
          
          <details>
          <summary>üìã View Details</summary>
          
          \`\`\`
          $(cat /tmp/results.txt)
          \`\`\`
          
          </details>
          
          EOF
              
              echo ""
            fi
          done
          
          echo "‚úÖ Validation completed"

      - name: Validate Kubernetes Manifests with Kyverno (Admission Control)
        if: hashFiles('policies/kyverno/**') != ''
        run: |
          echo "üõ°Ô∏è Validating Kubernetes manifests with Kyverno policies..."
          echo ""
          
          # Install Kyverno CLI
          curl -LO https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          tar -xzf kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/
          rm kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          
          # Install Helm
          curl -s https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash > /dev/null 2>&1
          
          # Test Helm templates
          for chart in apps/*/; do
            if [[ -f "$chart/Chart.yaml" ]]; then
              chart_name=$(basename "$chart")
              echo "üì¶ Testing $chart_name with Kyverno..."
              
              helm template "$chart_name" "$chart" > "/tmp/${chart_name}.yaml" 2>/dev/null || continue
              
              # Apply Kyverno policies
              kyverno apply policies/kyverno/*.yaml --resource "/tmp/${chart_name}.yaml" > /tmp/kyverno-results.txt 2>&1 || true
              
              cat /tmp/kyverno-results.txt
              echo ""
              
              # Parse results from summary line (e.g., "pass: 28, fail: 0, warn: 0, error: 0, skip: 8")
              SUMMARY=$(grep -E "^pass:" /tmp/kyverno-results.txt || echo "pass: 0")
              PASSED=$(echo "$SUMMARY" | grep -oP 'pass:\s*\K\d+' || echo "0")
              FAILED=$(echo "$SUMMARY" | grep -oP 'fail:\s*\K\d+' || echo "0")
              WARNINGS=$(echo "$SUMMARY" | grep -oP 'warn:\s*\K\d+' || echo "0")
              SKIPPED=$(echo "$SUMMARY" | grep -oP 'skip:\s*\K\d+' || echo "0")
              
              # GitHub Summary
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üõ°Ô∏è Kyverno Validation: $chart_name
          **Admission Control:** Kubernetes Pod Security Standards enforcement
          
          | ‚úÖ Passed | ‚ùå Failed | ‚ö†Ô∏è Warnings | ‚è≠Ô∏è Skipped |
          |-----------|----------|-------------|-----------|
          | $PASSED | $FAILED | $WARNINGS | $SKIPPED |
          
          <details>
          <summary>üìã View Details</summary>
          
          \`\`\`
          $(cat /tmp/kyverno-results.txt)
          \`\`\`
          
          </details>
          
          EOF
              echo ""
            fi
          done
          
          echo "‚úÖ Kyverno policy tests completed"

      - name: Scan Infrastructure as Code with Checkov (IaC Security)
        id: checkov
        continue-on-error: true  # Capture results even with failures
        run: |
          echo "Running Checkov IaC security scanning..."
          
          # Install checkov if not available
          pip install checkov >/dev/null 2>&1 || true
          
          # Run Checkov with both console and SARIF output
          checkov -d . \
            --framework kubernetes terraform dockerfile \
            --skip-check CKV_K8S_43,CKV_K8S_35 \
            --skip-path test-pod.yaml,test-pvc.yaml,Future/ \
            --output cli \
            --compact \
            2>&1 | tee /tmp/checkov-output.txt
          
          # Generate SARIF file separately for upload
          checkov -d . \
            --framework kubernetes terraform dockerfile \
            --skip-check CKV_K8S_43,CKV_K8S_35 \
            --skip-path test-pod.yaml,test-pvc.yaml,Future/ \
            --output sarif \
            --output-file-path . \
            >/dev/null 2>&1 || true
          
          # Store exit code
          CHECKOV_EXIT=$?
          
          # Parse the summary line - Checkov outputs like "Passed checks: 266, Failed checks: 3, Skipped checks: 0"
          SUMMARY=$(grep -E "^(kubernetes|terraform|dockerfile) scan results:" -A 2 /tmp/checkov-output.txt | tail -1)
          
          # Extract numbers - looking for pattern "Passed checks: X, Failed checks: Y, Skipped checks: Z"
          PASSED=$(echo "$SUMMARY" | grep -oP 'Passed checks:\s*\K\d+' || echo "0")
          FAILED=$(echo "$SUMMARY" | grep -oP 'Failed checks:\s*\K\d+' || echo "0")
          SKIPPED=$(echo "$SUMMARY" | grep -oP 'Skipped checks:\s*\K\d+' || echo "0")
          
          # Fallback: if parsing failed, try to count from full output
          if [ "$PASSED" = "0" ] && [ "$FAILED" = "0" ]; then
            PASSED=$(grep -c "Check: CKV" /tmp/checkov-output.txt 2>/dev/null || echo "0")
            FAILED=$(grep -c "FAILED for resource:" /tmp/checkov-output.txt 2>/dev/null || echo "0")
          fi
          
          # Output for next step
          echo "CHECKOV_PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "CHECKOV_FAILED=$FAILED" >> $GITHUB_OUTPUT
          echo "CHECKOV_SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          
          # GitHub Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üîç Checkov IaC Security Scanning
          **Infrastructure as Code:** Kubernetes, Terraform, and Dockerfile security validation
          
          | ‚úÖ Passed | ‚ùå Failed | ‚è≠Ô∏è Skipped |
          |----------|---------|-----------|
          | $PASSED | $FAILED | $SKIPPED |
          
          EOF
          
          if [ "$FAILED" -gt "0" ]; then
            echo "‚ö†Ô∏è **Action Required:** $FAILED security issues found!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the detailed output above for specific violations and remediation guidance." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "‚úÖ All Checkov security checks passed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Checkov Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif-results
          path: results_sarif.sarif
          retention-days: 30

  # ==========================================
  # STAGE 3: Build, Test, Scan, Push
  # ==========================================
  # COMMENTED OUT FOR TESTING - Uncomment after policy tests work
  # build-and-scan:
  #   name: üèóÔ∏è Build ${{ matrix.service }}
  #   runs-on: ubuntu-latest
  #   needs: [detect-changes, policy-checks]
  #   if: |
  #     always() &&
  #     needs.detect-changes.outputs.has_changes == 'true' &&
  #     (needs.policy-checks.result == 'success' || needs.policy-checks.result == 'skipped')
  #   
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
  #   
  #   steps:
  #     ... (all build steps commented)
  
  # ==========================================
  # STAGE 4: Update Manifests
  # ==========================================
  # COMMENTED OUT FOR TESTING
  # update-manifests:
  #   ... (commented)
  
  # ==========================================
  # STAGE 5: Notify
  # ==========================================
  # COMMENTED OUT FOR TESTING
  # notify:
  #   ... (commented)
