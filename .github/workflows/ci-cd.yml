name: CI/CD Pipeline - FreshBonds

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'apps/*/templates/**'
      - 'Dockerfile'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'apps/*/templates/**'
      - 'Dockerfile'

permissions:
  contents: write          # Required for pushing manifest updates
  security-events: write   # Required for SARIF uploads
  packages: read
  pull-requests: write     # For PR comments

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_PREFIX: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # ==========================================
  # STAGE 1: Detect Changes
  # ==========================================
  detect-changes:
    name: üîç Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Services
        id: detect
        run: |
          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "üìù Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Initialize services array
          SERVICES=()
          
          # Check each service directory
          if echo "$CHANGED_FILES" | grep -q "^src/frontend/"; then
            SERVICES+=("frontend")
            echo "‚úÖ Detected: frontend"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/api-gateway/"; then
            SERVICES+=("api-gateway")
            echo "‚úÖ Detected: api-gateway"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/user-service/"; then
            SERVICES+=("user-service")
            echo "‚úÖ Detected: user-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^src/product-service/"; then
            SERVICES+=("product-service")
            echo "‚úÖ Detected: product-service"
          fi
          
          # If workflow or Dockerfile changed, rebuild all
          if echo "$CHANGED_FILES" | grep -qE "^(\.github/workflows/|Dockerfile)"; then
            echo "‚ö†Ô∏è Workflow or Dockerfile changed - rebuilding all services"
            SERVICES=("frontend" "api-gateway" "user-service" "product-service")
          fi
          
          # Create JSON array
          if [[ ${#SERVICES[@]} -eq 0 ]]; then
            echo "‚ÑπÔ∏è No services to build"
            SERVICES_JSON="[]"
            HAS_CHANGES="false"
          else
            SERVICES_JSON="["
            for i in "${!SERVICES[@]}"; do
              if [[ $i -gt 0 ]]; then
                SERVICES_JSON+=","
              fi
              SERVICES_JSON+="\"${SERVICES[$i]}\""
            done
            SERVICES_JSON+="]"
            HAS_CHANGES="true"
          fi
          
          echo ""
          echo "üéØ Services to build: ${SERVICES[*]}"
          echo "üìä JSON matrix: $SERVICES_JSON"
          
          # Validate JSON
          if ! echo "$SERVICES_JSON" | jq empty >/dev/null 2>&1; then
            echo "‚ùå Invalid JSON, using fallback"
            SERVICES_JSON='[]'
            HAS_CHANGES="false"
          fi
          
          echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ==========================================
  # STAGE 2: Infrastructure Security & Compliance Validation
  # ==========================================
  policy-checks:
    name: üîê Validate Infrastructure & Security Policies
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Kubernetes Manifests with OPA (Policy-as-Code)
        if: hashFiles('policies/opa/**') != ''
        run: |
          echo "üîç Validating Kubernetes manifests against OPA security policies..."
          echo ""
          
          # Install Conftest
          CONFTEST_VERSION=0.49.1
          curl -L -o conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz
          tar xzf conftest.tar.gz
          sudo mv conftest /usr/local/bin/
          rm conftest.tar.gz
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  STAGE 1: ArgoCD Application Manifests"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # Test Kubernetes manifests in clusters/ (ArgoCD Applications)
          if [[ -d "clusters" ]]; then
            YAML_FILES=$(find clusters -name "*.yaml" -o -name "*.yml")
            if [[ -n "$YAML_FILES" ]]; then
              echo "$YAML_FILES" | xargs conftest test --policy ./policies/opa > /tmp/opa-clusters.txt 2>&1 || true
              
              # Parse results
              TESTS=$(grep -oP '\d+(?= tests)' /tmp/opa-clusters.txt || echo "0")
              PASSED=$(grep -oP '\d+(?= passed)' /tmp/opa-clusters.txt || echo "0")
              WARNINGS=$(grep -oP '\d+(?= warnings)' /tmp/opa-clusters.txt || echo "0")
              FAILURES=$(grep -oP '\d+(?= failures)' /tmp/opa-clusters.txt || echo "0")
              
              echo "üìä Results:"
              echo "   ‚úÖ Passed:   $PASSED / $TESTS"
              echo "   ‚ö†Ô∏è  Warnings: $WARNINGS"
              echo "   ‚ùå Failures: $FAILURES"
              
              if [[ $FAILURES -gt 0 ]]; then
                echo ""
                echo "‚ö†Ô∏è Note: Failures in ArgoCD Applications are expected (they reference other resources)"
              fi
            fi
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  STAGE 2: Helm Templates (Rendered Manifests)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # Test Helm templates (render first)
          if [[ -d "apps" ]]; then
            # Install Helm
            curl -s https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash > /dev/null 2>&1
            
            # Render and test each Helm chart
            for chart in apps/*/; do
              if [[ -f "$chart/Chart.yaml" ]]; then
                chart_name=$(basename "$chart")
                echo "üì¶ Rendering: $chart_name"
                
                if helm template "$chart_name" "$chart" > "/tmp/${chart_name}-rendered.yaml" 2>/dev/null; then
                  echo "‚úÖ Rendered successfully"
                  echo ""
                  echo "üîç Running OPA policy validation..."
                  echo ""
                  
                  # Run conftest and capture output
                  conftest test --policy ./policies/opa "/tmp/${chart_name}-rendered.yaml" > /tmp/opa-helm.txt 2>&1 || true
                  
                  # Parse summary
                  TESTS=$(grep -oP '\d+(?= tests)' /tmp/opa-helm.txt | tail -1 || echo "0")
                  PASSED=$(grep -oP '\d+(?= passed)' /tmp/opa-helm.txt | tail -1 || echo "0")
                  WARNINGS=$(grep -oP '\d+(?= warnings)' /tmp/opa-helm.txt | tail -1 || echo "0")
                  FAILURES=$(grep -oP '\d+(?= failures)' /tmp/opa-helm.txt | tail -1 || echo "0")
                  
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo "  üìä Policy Validation Summary"
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo ""
                  printf "   %-15s %s / %s\n" "‚úÖ Passed:" "$PASSED" "$TESTS"
                  printf "   %-15s %s\n" "‚ö†Ô∏è  Warnings:" "$WARNINGS"
                  printf "   %-15s %s\n" "‚ùå Failures:" "$FAILURES"
                  echo ""
                  
                  # Show warnings if any
                  if [[ $WARNINGS -gt 0 ]]; then
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "  ‚ö†Ô∏è  WARNINGS (Best Practices)"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    grep "WARN -" /tmp/opa-helm.txt | sed 's/WARN - \/tmp\/.*\.yaml - main - /  ‚Ä¢ /' || true
                    echo ""
                  fi
                  
                  # Show failures if any
                  if [[ $FAILURES -gt 0 ]]; then
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "  ‚ùå FAILURES (Security Violations)"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    grep "FAIL -" /tmp/opa-helm.txt | sed 's/FAIL - \/tmp\/.*\.yaml - main - /  ‚Ä¢ /' || true
                    echo ""
                    echo "‚ö†Ô∏è  Security violations detected! These should be fixed before production."
                  fi
                  
                  # Create GitHub Step Summary
                  cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üîê OPA Policy Validation: $chart_name
          
          ### Summary
          | Status | Count |
          |--------|-------|
          | ‚úÖ Passed | $PASSED / $TESTS |
          | ‚ö†Ô∏è Warnings | $WARNINGS |
          | ‚ùå Failures | $FAILURES |
          
          EOF
                  
                  if [[ $WARNINGS -gt 0 ]]; then
                    echo "### ‚ö†Ô∏è Warnings" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    grep "WARN -" /tmp/opa-helm.txt | sed 's/WARN - \/tmp\/.*\.yaml - main - //' >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi
                  
                  if [[ $FAILURES -gt 0 ]]; then
                    echo "### ‚ùå Failures" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    grep "FAIL -" /tmp/opa-helm.txt | sed 's/FAIL - \/tmp\/.*\.yaml - main - //' >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                  fi
                  
                else
                  echo "‚ùå Failed to render $chart_name"
                fi
              fi
            done
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  ‚úÖ OPA Policy Validation Completed"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      # COMMENTED OUT FOR TESTING - Uncomment after OPA tests work
      # - name: Run Kyverno Policy Tests
      #   if: hashFiles('policies/kyverno/**') != ''
      #   run: |
      #     echo "üîç Running Kyverno policy tests..."
      #     
      #     # Install Kyverno CLI
      #     curl -LO https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz
      #     tar -xzf kyverno-cli_v1.11.0_linux_x86_64.tar.gz
      #     sudo mv kyverno /usr/local/bin/
      #     rm kyverno-cli_v1.11.0_linux_x86_64.tar.gz
      #     
      #     # Test Helm templates (render first)
      #     if [[ -d "apps" && -d "policies/kyverno" ]]; then
      #       echo "Testing Kyverno policies against Helm templates..."
      #       
      #       # Install Helm if not already installed
      #       if ! command -v helm &> /dev/null; then
      #         curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      #       fi
      #       
      #       # Render and test each Helm chart
      #       for chart in apps/*/; do
      #         if [[ -f "$chart/Chart.yaml" ]]; then
      #           chart_name=$(basename "$chart")
      #           echo "Testing $chart_name with Kyverno policies..."
      #           helm template "$chart_name" "$chart" > "/tmp/${chart_name}-rendered.yaml" 2>/dev/null || continue
      #           kyverno apply policies/kyverno/*.yaml --resource "/tmp/${chart_name}-rendered.yaml" || echo "‚ö†Ô∏è Some policies failed for $chart_name"
      #         fi
      #       done
      #     else
      #       echo "‚ö†Ô∏è apps/ or policies/kyverno/ directory not found, skipping Kyverno tests"
      #     fi
      #     
      #     echo "‚úÖ Kyverno policy tests completed"

      # - name: Run Checkov (IaC Security Scanning)
      #   uses: bridgecrewio/checkov-action@v12
      #   with:
      #     directory: .
      #     framework: kubernetes,terraform,dockerfile
      #     soft_fail: false
      #     output_format: cli,sarif
      #     output_file_path: console,checkov-results.sarif
      #     skip_check: CKV_K8S_43  # Image tag latest (handled by our workflow)

      # - name: Upload Checkov Results
      #   if: always()
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: checkov-results.sarif
      #     category: checkov-iac

  # ==========================================
  # STAGE 3: Build, Test, Scan, Push
  # ==========================================
  # COMMENTED OUT FOR TESTING - Uncomment after policy tests work
  # build-and-scan:
  #   name: üèóÔ∏è Build ${{ matrix.service }}
  #   runs-on: ubuntu-latest
  #   needs: [detect-changes, policy-checks]
  #   if: |
  #     always() &&
  #     needs.detect-changes.outputs.has_changes == 'true' &&
  #     (needs.policy-checks.result == 'success' || needs.policy-checks.result == 'skipped')
  #   
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
  #   
  #   steps:
  #     ... (all build steps commented)
  
  # ==========================================
  # STAGE 4: Update Manifests
  # ==========================================
  # COMMENTED OUT FOR TESTING
  # update-manifests:
  #   ... (commented)
  
  # ==========================================
  # STAGE 5: Notify
  # ==========================================
  # COMMENTED OUT FOR TESTING
  # notify:
  #   ... (commented)
