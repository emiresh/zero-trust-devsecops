apiVersion: batch/v1
kind: Job
metadata:
  name: freshbonds-db-init
  namespace: dev
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: db-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: db-init
        image: emiresh/freshbonds-user-service:v1.2.1
        workingDir: /app
        command:
          - node
          - -e
          - |
            const mongoose = require('mongoose');
            const User = require('./models/User');
            
            async function initializeDatabase() {
              const MONGODB_URI = process.env.MONGODB_URI;
              
              if (!MONGODB_URI) {
                console.error('‚ùå MONGODB_URI environment variable is required');
                process.exit(1);
              }
              
              try {
                console.log('üîó Connecting to MongoDB...');
                await mongoose.connect(MONGODB_URI, {
                  maxPoolSize: 10,
                  serverSelectionTimeoutMS: 5000,
                  socketTimeoutMS: 45000,
                });
                console.log('‚úÖ Connected to MongoDB');
                
                console.log('üë§ Creating admin user...');
                const existingUser = await User.findOne({ email: 'ireshek@gmail.com' });
                
                if (existingUser) {
                  console.log('‚ö†Ô∏è  Admin user already exists - skipping');
                } else {
                  const adminUser = new User({
                    name: 'Iresh Ekanayaka',
                    email: 'ireshek@gmail.com',
                    password: 'Iresh@1998',
                    role: 'admin',
                    location: 'Kurunegala, Sri Lanka',
                    farmName: 'Athugalpura',
                    mobile: '0766025562'
                  });
                  
                  await adminUser.save();
                  console.log('‚úÖ Admin user created successfully');
                  console.log('   Email: ireshek@gmail.com');
                  console.log('   Role: admin');
                }
                
                const userCount = await User.countDocuments();
                console.log(`\nüìã Total users in database: ${userCount}`);
                console.log('üéâ Database initialization complete!');
                
              } catch (error) {
                console.error('‚ùå Initialization error:', error);
                process.exit(1);
              } finally {
                await mongoose.connection.close();
                console.log('‚úÖ Database connection closed');
                process.exit(0);
              }
            }
            
            initializeDatabase();
        envFrom:
          - secretRef:
              name: freshbonds-secrets

